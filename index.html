<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Interactive Function & Derivative Plotter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
        window.MathJax = {
            loader: {load: ['input/asciimath', 'output/chtml']},
            asciimath: {
                delimiters: [['`', '`']]
            },
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f1e8;
            color: #5d4e37;
        }

        .title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 30px;
            color: #5d4e37;
        }

        .input-container {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
        }

        .input-box {
            background-color: #ede4d3;
            border: 2px solid #d4c4a8;
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .function-label {
            font-size: 18px;
            font-style: italic;
            color: #5d4e37;
            margin-right: 5px;
        }

        .equation-input {
            background-color: #f8f5f0;
            border: 1px solid #d4c4a8;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            color: #5d4e37;
            min-width: 200px;
        }

        .equation-input:focus {
            outline: none;
            border-color: #b8a082;
            box-shadow: 0 0 5px rgba(184, 160, 130, 0.3);
        }

        .plot-button {
            background-color: #d4c4a8;
            border: 1px solid #b8a082;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 16px;
            color: #5d4e37;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .plot-button:hover {
            background-color: #c4b49a;
        }

        .chart-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
        }

        .chart-row {
            display: flex;
            align-items: center;
            gap: 30px;
            width: 100%;
            max-width: 1000px;
        }

        .rendered-equation {
            min-width: 200px;
            font-size: 20px;
            color: #5d4e37;
            text-align: center;
            order: 1;
        }

        .chart-container {
            order: 2;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 2px
        }

        .hover-circle,
        .deriv-circle {
            pointer-events: none
        }

        .tangent-line {
            stroke-width: 2px;
            pointer-events: none
        }

        .slope-text,
        .deriv-text {
            font-size: 12px;
            pointer-events: none
        }
    </style>
</head>

<body>
    <div class="title">DERIVATIVE VISUALIZER</div>
    
    <div class="input-container">
        <div class="input-box">
            <span class="function-label">f(x) =</span>
            <input class="equation-input" id="equation" value="sin(x/2)*5 + 10">
            <button class="plot-button" id="updateBtn">Plot</button>
        </div>
    </div>

    <div class="chart-area">
        <div class="chart-row">
            <div class="rendered-equation" id="render-fx"></div>
            <div class="chart-container">
                <svg id="chart1" width="700" height="300"></svg>
            </div>
        </div>
        <div class="chart-row">
            <div class="rendered-equation" id="render-fpx"></div>
            <div class="chart-container">
                <svg id="chart2" width="700" height="200"></svg>
            </div>
        </div>
    </div>

    <script>
        function renderEquations(eqn) {
            // Use AsciiMath notation with backticks
            const fxAscii = `\`f(x) = ${eqn}\``;
            
            // Get derivative and render with AsciiMath
            const dexprStr = math.derivative(eqn, 'x').toString();
            const dAscii = `\`f'(x) = ${dexprStr}\``;
            
            // Set the HTML content
            document.getElementById('render-fx').innerHTML = fxAscii;
            document.getElementById('render-fpx').innerHTML = dAscii;
            
            // Render with MathJax
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise([document.getElementById('render-fx'), document.getElementById('render-fpx')])
                    .catch((err) => console.log('MathJax typeset failed: ' + err.message));
            }
        }

        function plot(eqn) {
            renderEquations(eqn);
            const expr = math.compile(eqn);
            const dexpr = math.derivative(eqn, 'x').compile();

            const xs = d3.range(0, 10.0001, 0.01);
            const data = xs.map(x => ({ x, y: expr.evaluate({ x }) }));
            const derivArr = xs.map(x => ({ x, dy: dexpr.evaluate({ x }) }));

            const margin = { top: 20, right: 30, bottom: 30, left: 40 };
            const width = 700 - margin.left - margin.right;

            d3.selectAll('#chart1 > *').remove();
            d3.selectAll('#chart2 > *').remove();

            const xScale = d3.scaleLinear().domain(d3.extent(data, d => d.x)).range([0, width]);
            const maxAbsDy = d3.max(derivArr, d => Math.abs(d.dy));
            const epsilonDy = maxAbsDy * 0.02;
            const epsilonX = 0.01;

            // Chart1
            const height1 = 300 - margin.top - margin.bottom;
            const yScale = d3.scaleLinear()
                .domain([d3.min(data, d => d.y), d3.max(data, d => d.y)]).nice()
                .range([height1, 0]);
            const g1 = d3.select('#chart1').append('g').attr('transform', `translate(${margin.left},${margin.top})`);
            g1.append('g').attr('transform', `translate(0,${yScale(0)})`).call(d3.axisBottom(xScale));
            g1.append('g').call(d3.axisLeft(yScale));
            g1.append('path').datum(data).attr('class', 'line')
                .attr('d', d3.line().x(d => xScale(d.x)).y(d => yScale(d.y)));

            // Chart2
            const height2 = 200 - margin.top - margin.bottom;
            const y2Scale = d3.scaleLinear().domain(d3.extent(derivArr, d => d.dy)).nice().range([height2, 0]);
            const zeroY2 = y2Scale(0);
            const g2 = d3.select('#chart2').append('g').attr('transform', `translate(${margin.left},${margin.top})`);
            g2.append('rect').attr('x', 0).attr('y', 0).attr('width', width).attr('height', zeroY2).attr('fill', '#d4edda');
            g2.append('rect').attr('x', 0).attr('y', zeroY2).attr('width', width).attr('height', height2 - zeroY2).attr('fill', '#f8d7da');
            g2.append('g').attr('transform', `translate(0,${zeroY2})`).call(d3.axisBottom(xScale));
            g2.append('g').call(d3.axisLeft(y2Scale));
            g2.append('path').datum(derivArr).attr('class', 'line')
                .attr('d', d3.line().x(d => xScale(d.x)).y(d => y2Scale(d.dy)));

            // Hover elements
            const hoverCircle = g1.append('circle').attr('r', 5).style('display', 'none');
            const tangentLine = g1.append('line').style('display', 'none');
            const slopeText = g1.append('text').style('display', 'none');
            const hoverCircle2 = g2.append('circle').attr('r', 5).style('display', 'none');
            const derivText = g2.append('text').style('display', 'none');
            const bisect = d3.bisector(d => d.x).left;

            function attachOverlay(group, height) {
                group.append('rect').attr('width', width).attr('height', height).attr('fill', 'none').attr('pointer-events', 'all')
                    .on('mouseover', () => {
                        hoverCircle.style('display', null);
                        tangentLine.style('display', null);
                        slopeText.style('display', null);
                        hoverCircle2.style('display', null);
                        derivText.style('display', null);
                    })
                    .on('mouseout', () => {
                        hoverCircle.style('display', 'none');
                        tangentLine.style('display', 'none');
                        slopeText.style('display', 'none');
                        hoverCircle2.style('display', 'none');
                        derivText.style('display', 'none');
                    })
                    .on('mousemove', event => {
                        const [mx] = d3.pointer(event, group.node());
                        let x0 = xScale.invert(mx);
                        const candidates = derivArr.filter(d => Math.abs(d.x - x0) < epsilonX && Math.abs(d.dy) < epsilonDy);
                        if (candidates.length) {
                            const nearest = candidates.reduce((a, b) => Math.abs(b.x - x0) < Math.abs(a.x - x0) ? b : a);
                            x0 = nearest.x;
                        }
                        const y0 = expr.evaluate({ x: x0 });
                        const rawDy = dexpr.evaluate({ x: x0 });
                        const m = Math.abs(rawDy) < epsilonDy ? 0 : rawDy;
                        const color = m === 0 ? 'grey' : (m > 0 ? 'green' : 'red');
                        const fill = m === 0 ? 'lightgrey' : (m > 0 ? '#c3e6cb' : '#f5c6cb');

                        hoverCircle.attr('cx', xScale(x0)).attr('cy', yScale(y0)).attr('fill', fill).attr('stroke', color);
                        tangentLine.attr('x1', xScale(x0 - 1)).attr('y1', yScale(y0 - m)).attr('x2', xScale(x0 + 1)).attr('y2', yScale(y0 + m)).style('stroke', color);
                        slopeText.attr('x', xScale(x0) + 5).attr('y', yScale(y0) - 5).attr('fill', color).text('m = ' + m.toFixed(2));

                        hoverCircle2.attr('cx', xScale(x0)).attr('cy', y2Scale(m));
                        derivText.attr('x', xScale(x0) + 5).attr('y', y2Scale(m) - 5).text('y = ' + m.toFixed(2));
                    });
            }

            attachOverlay(g1, height1);
            attachOverlay(g2, height2);
        }

        // Wait for MathJax to be ready before plotting
        window.addEventListener('load', function() {
            if (window.MathJax) {
                MathJax.startup.promise.then(() => {
                    plot(document.getElementById('equation').value);
                });
            } else {
                plot(document.getElementById('equation').value);
            }
        });
        
        document.getElementById('updateBtn').addEventListener('click', () => plot(document.getElementById('equation').value));
    </script>
</body>

</html>
